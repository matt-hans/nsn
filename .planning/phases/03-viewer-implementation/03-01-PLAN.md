---
phase: 03-viewer-implementation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - viewer/package.json
  - viewer/src/services/p2pClient.ts
autonomous: true

must_haves:
  truths:
    - "libp2p node can be created in browser environment"
    - "WebRTC-Direct transport is configured for outbound dialing"
  artifacts:
    - path: "viewer/package.json"
      provides: "libp2p dependencies"
      contains: "libp2p"
    - path: "viewer/src/services/p2pClient.ts"
      provides: "P2P client service class"
      exports: ["P2PClient"]
      min_lines: 80
  key_links:
    - from: "viewer/src/services/p2pClient.ts"
      to: "libp2p"
      via: "import { createLibp2p }"
      pattern: "createLibp2p"
---

<objective>
Install js-libp2p dependencies and create the core P2PClient service class.

Purpose: Establish the P2P foundation that replaces simple-peer + signaling server architecture.
Output: Working libp2p node creation with WebRTC-Direct transport for browser-to-mesh connectivity.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-viewer-implementation/03-CONTEXT.md
@.planning/phases/03-viewer-implementation/03-RESEARCH.md

# Existing files to understand current architecture
@viewer/package.json
@viewer/src/services/p2p.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install js-libp2p dependencies</name>
  <files>viewer/package.json</files>
  <action>
Install the libp2p ecosystem packages for browser P2P connectivity:

```bash
cd viewer
pnpm add libp2p @libp2p/webrtc @chainsafe/libp2p-noise @chainsafe/libp2p-yamux @chainsafe/libp2p-gossipsub @libp2p/identify @multiformats/multiaddr @polkadot/types @polkadot/types-codec
```

Then remove the old simple-peer dependency that is being replaced:

```bash
pnpm remove simple-peer @types/simple-peer
```

Note: Keep existing React, Zustand, and dev dependencies unchanged.
  </action>
  <verify>
- `pnpm install` succeeds without errors
- `pnpm build` succeeds (TypeScript compiles)
- package.json contains libp2p, @libp2p/webrtc, @chainsafe/libp2p-gossipsub
- package.json does NOT contain simple-peer
  </verify>
  <done>
Dependencies installed: libp2p v3.x ecosystem packages present, simple-peer removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create P2PClient service class</name>
  <files>viewer/src/services/p2pClient.ts</files>
  <action>
Create the core P2PClient class that wraps libp2p node lifecycle.

Key implementation details:
1. Use `webRTCDirect()` transport (NOT `webRTC()` - no circuit relay needed)
2. Use `noise()` for encryption, `yamux()` for muxing
3. Configure `gossipsub` with `emitSelf: false`, `fallbackToFloodsub: false`
4. Include `identify` service for protocol negotiation
5. NO listen addresses (browsers cannot accept incoming connections)
6. Connection manager: maxConnections 10, minConnections 1

Export:
- `P2PClient` class with methods:
  - `async initialize(): Promise<void>` - creates libp2p node
  - `async dial(multiaddr: string): Promise<void>` - dials a peer
  - `subscribe(topic: string, handler: (data: Uint8Array) => void): void` - subscribes to GossipSub topic
  - `async stop(): Promise<void>` - shuts down node
  - `isStarted(): boolean` - check if node is running
  - `getPeerId(): string | null` - get local peer ID
  - `getConnectedPeers(): number` - count of connected peers

Implementation notes:
- Store node instance as private property
- Handle initialization errors gracefully (throw descriptive Error)
- Use `@multiformats/multiaddr` to parse multiaddr string before dialing
- For GossipSub, use `this.node.services.pubsub.subscribe(topic)` and `addEventListener('message', ...)`

Reference the research document for exact import paths:
- `import { createLibp2p } from 'libp2p'`
- `import { webRTCDirect } from '@libp2p/webrtc'`
- `import { noise } from '@chainsafe/libp2p-noise'`
- `import { yamux } from '@chainsafe/libp2p-yamux'`
- `import { gossipsub } from '@chainsafe/libp2p-gossipsub'`
- `import { identify } from '@libp2p/identify'`
- `import { multiaddr } from '@multiformats/multiaddr'`
  </action>
  <verify>
- `pnpm typecheck` passes
- `pnpm lint` passes
- File exports P2PClient class
- Class has all required methods
  </verify>
  <done>
P2PClient service exists with WebRTC-Direct transport, GossipSub, and basic lifecycle methods.
  </done>
</task>

</tasks>

<verification>
```bash
cd viewer
pnpm typecheck && pnpm lint && pnpm build
```

All commands pass. Package.json shows correct dependencies. p2pClient.ts is well-formed.
</verification>

<success_criteria>
- libp2p dependencies installed in package.json
- simple-peer removed from package.json
- P2PClient class created with WebRTC-Direct + GossipSub configuration
- TypeScript compiles without errors
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-viewer-implementation/03-01-SUMMARY.md`
</output>
