# Vortex Configuration
# VRAM budget for RTX 3060 12GB: 11.8GB total, 11.5GB hard limit (500MB safety margin)

device:
  # Primary compute device - "cuda:0" for GPU, "cpu" for fallback (testing only)
  name: "cuda:0"
  # Enable TF32 for faster matmul on Ampere+ GPUs
  allow_tf32: true

vram:
  # Soft limit (11.0GB) - log warning but continue
  soft_limit_gb: 11.0
  # Hard limit (11.5GB) - raise error and abort
  hard_limit_gb: 11.5
  # Monitoring interval (seconds)
  monitor_interval_sec: 5.0

models:
  # Model precision overrides (for debugging or VRAM optimization)
  # Production values: flux=nf4, liveportrait=fp16, kokoro=fp32, clip=int8
  precision:
    flux: "nf4"           # 4-bit NormalFloat quantization
    liveportrait: "fp16"  # Half precision
    kokoro: "fp32"        # Full precision (small model, quality matters)
    clip_b: "int8"        # 8-bit integer quantization
    clip_l: "int8"        # 8-bit integer quantization

buffers:
  # Pre-allocated output buffers (prevents fragmentation during generation)
  # Sizes in pixels/samples - buffers allocated at pipeline initialization
  actor:
    height: 512
    width: 512
    channels: 3
  video:
    frames: 1080          # 45 seconds * 24 fps
    height: 512
    width: 512
    channels: 3
  audio:
    sample_rate: 24000
    duration_sec: 45
    samples: 1080000      # 24000 * 45

pipeline:
  # Slot generation timeout (seconds) - abort if exceeded
  generation_timeout_sec: 20.0
  # Enable async parallelization for audio + image generation
  parallel_audio_actor: true

plugins:
  # Enable plugin discovery for custom renderers
  enabled: true
  # Directory containing plugin folders with manifest.yaml
  directory: "plugins"
  # Sandbox execution settings (required for untrusted plugins)
  sandbox:
    # Enable sandboxed execution (Docker by default)
    enabled: true
    # Sandbox engine: "docker" (recommended) or "process" (dev only)
    engine: "docker"
    # Docker image containing Vortex runtime + sandbox runner
    docker_image: "nsn-vortex:latest"
    # Docker CLI binary name/path
    docker_bin: "docker"
    # Network mode for plugin containers (default denies outbound network)
    network: "none"
    # Resource limits (host-side cgroup caps)
    memory_mb: 4096
    cpu_cores: 2.0
    pids_limit: 256
    tmpfs_mb: 64
    # Optional GPU request (e.g., "all" or "device=0")
    gpus: null
    # Grace period added to timeout before killing container
    timeout_grace_ms: 5000
    # Seccomp profile ("default" uses Docker default, or provide a profile path)
    seccomp_profile: "default"
    # Allow unsafe sandbox engines (process) - requires VORTEX_ALLOW_UNSAFE_SANDBOX=1
    allow_insecure: false
  # Plugin policy limits (defaults favor Lane 0 latency protection)
  policy:
    # Maximum VRAM any plugin can declare (GB)
    max_vram_gb: 11.5
    # Lane-specific latency budgets (ms)
    lane0_max_latency_ms: 15000
    lane1_max_latency_ms: 120000
    # SECURITY: Untrusted plugins are DISABLED by default.
    # Only explicitly allowlisted plugins can execute.
    # Set to true ONLY for development/testing with trusted plugin sources.
    # WARNING: Enabling untrusted plugins allows arbitrary Python code execution!
    allow_untrusted: false
    # Allowlist of plugin names that may execute even with allow_untrusted=false
    allowlist: []

# Slot timing orchestration (T020)
orchestration:
  # Per-stage timeouts (seconds) - prevent infinite hangs
  timeouts:
    audio_s: 3     # Kokoro TTS timeout (2s target)
    image_s: 15    # Flux-Schnell timeout (12s target)
    video_s: 10    # LivePortrait timeout (8s target)
    clip_s: 2      # Dual CLIP ensemble timeout (1s target)

  # Retry policy per stage (0 = no retry)
  retry_policy:
    audio: 1   # Retry audio once (recovers from transient CUDA errors)
    image: 0   # No image retry (too expensive time-wise)
    video: 0   # No video retry (too expensive time-wise)
    clip: 0    # No CLIP retry (fast, rarely fails)

  # Deadline buffer (seconds) - safety margin for deadline tracking
  # Larger buffer = more conservative abort (fewer false positives)
  # Smaller buffer = more aggressive (risk missing deadline)
  deadline_buffer_s: 5

logging:
  # JSON structured logging for Vector â†’ Loki aggregation
  format: "json"
  level: "INFO"
  # Include VRAM stats in every log message
  include_vram_stats: true
