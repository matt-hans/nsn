# =============================================================================
# NSN Testnet Deployment - Docker Compose
# =============================================================================
# Production-ready multi-node configuration for NSN testnet
#
# Services:
#   - 3 validator nodes (Alice, Bob, Charlie)
#   - 2 off-chain director nodes
#   - 1 Vortex GPU node (Lane 0 generation)
#   - 1 WebRTC signaling server
#   - Prometheus + Grafana observability
#   - Jaeger distributed tracing
#
# Security:
#   - Safe RPC methods only
#   - Restricted CORS origins
#   - Non-root container execution
#   - Docker secrets for sensitive keys
#   - Resource limits enforced
#
# Usage:
#   cp .env.example .env
#   docker compose up -d
#   docker compose logs -f
# =============================================================================

services:
  # ===========================================================================
  # Validator Nodes (3-node BFT consensus)
  # ===========================================================================

  validator-alice:
    image: nsn-node:${NSN_VERSION:-latest}
    container_name: nsn-validator-alice
    command: >
      --chain=/chain-spec/testnet.json
      --alice
      --validator
      --base-path=/data
      --port=30333
      --rpc-port=9944
      --rpc-external
      --rpc-cors=https://polkadot.js.org,https://nsn.network,${NSN_ALLOWED_ORIGINS:-}
      --rpc-methods=Safe
      --prometheus-external
      --prometheus-port=9615
      --telemetry-url=${NSN_TELEMETRY_URL:-wss://telemetry.nsn.network/submit} 0
      --name=alice-validator
      --node-key-file=/secrets/alice-node-key
    volumes:
      - alice-data:/data
      - ./chain-spec:/chain-spec:ro
      - ./secrets:/secrets:ro
    ports:
      - "${ALICE_P2P_PORT:-30333}:30333"
      - "${ALICE_RPC_PORT:-9944}:9944"
      - "${ALICE_PROMETHEUS_PORT:-9615}:9615"
    networks:
      - nsn-testnet
    deploy:
      resources:
        limits:
          memory: ${VALIDATOR_MEMORY_LIMIT:-4G}
          cpus: '${VALIDATOR_CPU_LIMIT:-2}'
        reservations:
          memory: 2G
          cpus: '1'
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9944/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  validator-bob:
    image: nsn-node:${NSN_VERSION:-latest}
    container_name: nsn-validator-bob
    command: >
      --chain=/chain-spec/testnet.json
      --bob
      --validator
      --base-path=/data
      --port=30333
      --rpc-port=9944
      --rpc-external
      --rpc-cors=https://polkadot.js.org,https://nsn.network,${NSN_ALLOWED_ORIGINS:-}
      --rpc-methods=Safe
      --prometheus-external
      --prometheus-port=9615
      --telemetry-url=${NSN_TELEMETRY_URL:-wss://telemetry.nsn.network/submit} 0
      --name=bob-validator
      --node-key-file=/secrets/bob-node-key
      --bootnodes=/dns/validator-alice/tcp/30333/p2p/${ALICE_PEER_ID:-12D3KooWAlice}
    volumes:
      - bob-data:/data
      - ./chain-spec:/chain-spec:ro
      - ./secrets:/secrets:ro
    ports:
      - "${BOB_P2P_PORT:-30334}:30333"
      - "${BOB_RPC_PORT:-9945}:9944"
      - "${BOB_PROMETHEUS_PORT:-9616}:9615"
    networks:
      - nsn-testnet
    deploy:
      resources:
        limits:
          memory: ${VALIDATOR_MEMORY_LIMIT:-4G}
          cpus: '${VALIDATOR_CPU_LIMIT:-2}'
        reservations:
          memory: 2G
          cpus: '1'
    restart: unless-stopped
    depends_on:
      validator-alice:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9944/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  validator-charlie:
    image: nsn-node:${NSN_VERSION:-latest}
    container_name: nsn-validator-charlie
    command: >
      --chain=/chain-spec/testnet.json
      --charlie
      --validator
      --base-path=/data
      --port=30333
      --rpc-port=9944
      --rpc-external
      --rpc-cors=https://polkadot.js.org,https://nsn.network,${NSN_ALLOWED_ORIGINS:-}
      --rpc-methods=Safe
      --prometheus-external
      --prometheus-port=9615
      --telemetry-url=${NSN_TELEMETRY_URL:-wss://telemetry.nsn.network/submit} 0
      --name=charlie-validator
      --node-key-file=/secrets/charlie-node-key
      --bootnodes=/dns/validator-alice/tcp/30333/p2p/${ALICE_PEER_ID:-12D3KooWAlice}
    volumes:
      - charlie-data:/data
      - ./chain-spec:/chain-spec:ro
      - ./secrets:/secrets:ro
    ports:
      - "${CHARLIE_P2P_PORT:-30335}:30333"
      - "${CHARLIE_RPC_PORT:-9946}:9944"
      - "${CHARLIE_PROMETHEUS_PORT:-9617}:9615"
    networks:
      - nsn-testnet
    deploy:
      resources:
        limits:
          memory: ${VALIDATOR_MEMORY_LIMIT:-4G}
          cpus: '${VALIDATOR_CPU_LIMIT:-2}'
        reservations:
          memory: 2G
          cpus: '1'
    restart: unless-stopped
    depends_on:
      validator-alice:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9944/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # ===========================================================================
  # Off-Chain Director Nodes (Lane 0 orchestration)
  # ===========================================================================

  director-1:
    image: nsn-offchain:${NSN_VERSION:-latest}
    container_name: nsn-director-1
    command: >
      director-only
      --config=/config/director.toml
      --rpc-url=ws://validator-alice:9944
      --p2p-listen-port=9000
      --p2p-metrics-port=9100
      --attestation-submit-mode=dual
      --attestation-suri=${DIRECTOR1_SURI:-//Director1}
      --storage-backend=ipfs
      --ipfs-api-url=http://ipfs:5001
      --log-level=${LOG_LEVEL:-info}
    volumes:
      - director1-data:/data
      - ./config:/config:ro
    ports:
      - "${DIRECTOR1_P2P_PORT:-9000}:9000"
      - "${DIRECTOR1_METRICS_PORT:-9100}:9100"
    networks:
      - nsn-testnet
    deploy:
      resources:
        limits:
          memory: ${DIRECTOR_MEMORY_LIMIT:-2G}
          cpus: '${DIRECTOR_CPU_LIMIT:-1}'
        reservations:
          memory: 1G
          cpus: '0.5'
    restart: unless-stopped
    depends_on:
      validator-alice:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9100/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  director-2:
    image: nsn-offchain:${NSN_VERSION:-latest}
    container_name: nsn-director-2
    command: >
      director-only
      --config=/config/director.toml
      --rpc-url=ws://validator-bob:9944
      --p2p-listen-port=9000
      --p2p-metrics-port=9100
      --attestation-submit-mode=dual
      --attestation-suri=${DIRECTOR2_SURI:-//Director2}
      --storage-backend=ipfs
      --ipfs-api-url=http://ipfs:5001
      --log-level=${LOG_LEVEL:-info}
    volumes:
      - director2-data:/data
      - ./config:/config:ro
    ports:
      - "${DIRECTOR2_P2P_PORT:-9001}:9000"
      - "${DIRECTOR2_METRICS_PORT:-9101}:9100"
    networks:
      - nsn-testnet
    deploy:
      resources:
        limits:
          memory: ${DIRECTOR_MEMORY_LIMIT:-2G}
          cpus: '${DIRECTOR_CPU_LIMIT:-1}'
        reservations:
          memory: 1G
          cpus: '0.5'
    restart: unless-stopped
    depends_on:
      validator-bob:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9100/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  # ===========================================================================
  # Vortex GPU Node (Lane 0 AI generation)
  # ===========================================================================

  vortex:
    image: nsn-vortex:${NSN_VERSION:-latest}
    container_name: nsn-vortex
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-all}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
      - VORTEX_MODELS_PATH=/models
      - VORTEX_MAX_VRAM_GB=${VORTEX_MAX_VRAM_GB:-11.8}
      - VORTEX_BATCH_SIZE=${VORTEX_BATCH_SIZE:-1}
    volumes:
      - model-weights:/models
      - vortex-output:/output
      - ./config/vortex.yaml:/app/config.yaml:ro
    ports:
      - "${VORTEX_GRPC_PORT:-50051}:50051"
      - "${VORTEX_METRICS_PORT:-9102}:9100"
    networks:
      - nsn-testnet
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
        limits:
          memory: ${VORTEX_MEMORY_LIMIT:-16G}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python3", "-c", "import torch; assert torch.cuda.is_available()"]
      interval: 60s
      timeout: 15s
      retries: 3
      start_period: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # ===========================================================================
  # WebRTC Signaling Server
  # ===========================================================================

  signaling:
    image: nsn-signaling:${NSN_VERSION:-latest}
    container_name: nsn-signaling
    ports:
      - "${SIGNALING_PORT:-8080}:8080"
    networks:
      - nsn-testnet
    deploy:
      resources:
        limits:
          memory: ${SIGNALING_MEMORY_LIMIT:-256M}
          cpus: '0.5'
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

  # ===========================================================================
  # IPFS Node (Content storage)
  # ===========================================================================

  ipfs:
    image: ipfs/kubo:v0.24.0
    container_name: nsn-ipfs
    environment:
      - IPFS_PROFILE=server
    volumes:
      - ipfs-data:/data/ipfs
    ports:
      - "${IPFS_API_PORT:-5001}:5001"
      - "${IPFS_GATEWAY_PORT:-8081}:8080"
      - "${IPFS_SWARM_PORT:-4001}:4001"
    networks:
      - nsn-testnet
    deploy:
      resources:
        limits:
          memory: ${IPFS_MEMORY_LIMIT:-2G}
          cpus: '1'
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "ipfs swarm peers || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  # ===========================================================================
  # Observability Stack
  # ===========================================================================

  prometheus:
    image: prom/prometheus:v2.47.0
    container_name: nsn-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=${PROMETHEUS_RETENTION_DAYS:-15}d'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./alerts:/etc/prometheus/alerts:ro
      - prometheus-data:/prometheus
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    networks:
      - nsn-testnet
    deploy:
      resources:
        limits:
          memory: ${PROMETHEUS_MEMORY_LIMIT:-2G}
          cpus: '1'
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  grafana:
    image: grafana/grafana:10.0.0
    container_name: nsn-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:?GRAFANA_ADMIN_PASSWORD is required}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_AUTH_ANONYMOUS_ENABLED=${GRAFANA_ANONYMOUS_ENABLED:-false}
      - GF_SERVER_ROOT_URL=${GRAFANA_ROOT_URL:-http://localhost:3000}
      - GF_INSTALL_PLUGINS=grafana-clock-panel
    volumes:
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana-data:/var/lib/grafana
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    networks:
      - nsn-testnet
    deploy:
      resources:
        limits:
          memory: ${GRAFANA_MEMORY_LIMIT:-512M}
          cpus: '0.5'
    restart: unless-stopped
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  jaeger:
    image: jaegertracing/all-in-one:1.50
    container_name: nsn-jaeger
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - SPAN_STORAGE_TYPE=badger
      - BADGER_EPHEMERAL=false
      - BADGER_DIRECTORY_VALUE=/badger/data
      - BADGER_DIRECTORY_KEY=/badger/key
    volumes:
      - jaeger-data:/badger
    ports:
      - "${JAEGER_UI_PORT:-16686}:16686"
      - "${JAEGER_OTLP_GRPC_PORT:-4317}:4317"
      - "${JAEGER_OTLP_HTTP_PORT:-4318}:4318"
    networks:
      - nsn-testnet
    deploy:
      resources:
        limits:
          memory: ${JAEGER_MEMORY_LIMIT:-1G}
          cpus: '0.5'
    restart: unless-stopped
    profiles:
      - tracing
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:14269/"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  # ===========================================================================
  # NAT Traversal (STUN/TURN)
  # ===========================================================================

  stun-turn:
    image: coturn/coturn:4.6-alpine
    container_name: nsn-stun-turn
    command: >
      -n
      --listening-port=3478
      --tls-listening-port=5349
      --fingerprint
      --lt-cred-mech
      --user=${TURN_USER:-nsn}:${TURN_PASSWORD:?TURN_PASSWORD is required}
      --realm=${TURN_REALM:-nsn.network}
      --external-ip=${EXTERNAL_IP:-}
      --relay-ip=0.0.0.0
      --min-port=49152
      --max-port=49200
      --verbose
    ports:
      - "${STUN_PORT:-3478}:3478/udp"
      - "${STUN_PORT:-3478}:3478/tcp"
      - "${TURN_TLS_PORT:-5349}:5349/udp"
      - "${TURN_TLS_PORT:-5349}:5349/tcp"
      - "49152-49200:49152-49200/udp"
    networks:
      - nsn-testnet
    deploy:
      resources:
        limits:
          memory: ${STUN_TURN_MEMORY_LIMIT:-512M}
          cpus: '0.5'
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

# =============================================================================
# Volumes
# =============================================================================

volumes:
  # Validator chain data
  alice-data:
    driver: local
  bob-data:
    driver: local
  charlie-data:
    driver: local

  # Off-chain node data
  director1-data:
    driver: local
  director2-data:
    driver: local

  # AI engine data
  model-weights:
    driver: local
  vortex-output:
    driver: local

  # Storage
  ipfs-data:
    driver: local

  # Observability data
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  jaeger-data:
    driver: local

# =============================================================================
# Networks
# =============================================================================

networks:
  nsn-testnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/16
